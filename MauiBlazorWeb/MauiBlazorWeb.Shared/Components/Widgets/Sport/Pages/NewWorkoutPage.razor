@page "/new-workout/id={AccountDoesId:int}"
@page "/new-workout/routineid={RoutineId:int}"
@inherits SportCompBase

@using Bases
@using MauiBlazorWeb.Shared.Components.Dialogs
@using MauiBlazorWeb.Shared.Components.Widgets.Sport.Dialogs
@using MauiBlazorWeb.Shared.Components.Icons
@using Models.Sports

@if (!_appState.IsLoggedIn)
{
	<NotLoggedIn/>
}
else if (hasInvalidParameter)
{
	<h3>This is not a valid path to a New Workout page</h3>
}
else
{
	<div class="row">
		<div class="col-auto m-2 float-end">
			<div class="row" style="background-color: darkgrey">
				<div class="col">
					<div class="row">
						<div class="col-auto">
							<h4>
								Workout duration: @(clock.Hours == 0 ? clock.ToString(@"mm\:ss") : clock.ToString(@"hh:\mm\:ss"))
							</h4>
						</div>
						<div class="col-auto float-end">
							<button class="btn btn-primary" @onclick="OnFinishWorkout">
								Finish Workout
							</button>
						</div>
					</div>
				</div>
			</div>
			<div class="row" style="background-color: lightgray">
				<div class="col">
					<table class="table table-striped text-center">
						@if (exercises.Count != 0)
						{
							<thead class="thead-light">
								<tr>
									<th>Name</th>
									<th colspan="2">Reorder</th>
									<th>Del</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var ex in exercises)
								{
									<tr>
										<td>
											@ex.Name
										</td>
										<td>
											@if (exercises.First() != ex)
											{
												<button class="btn btn-info" @onclick="() => MoveExerciseUp(ex)">
													<IconUp />
												</button>
											}
											else
											{
												<IconDash />
											}
										</td>
										<td>
											@if (exercises.Last() != ex)
											{
												<button class="btn btn-info" @onclick="() => MoveExerciseDown(ex)">
													<IconDown />
												</button>
											}
											else
											{
												<IconDash />
											}
										</td>
										<td>
											<button class="btn btn-danger" @onclick="() => RemoveExercise(ex)">
												<IconDelete />
											</button>
										</td>
									</tr>
								}
							</tbody>
						}
						else
						{
							<thead class="thead-light">
								<tr>
									<th colspan="4">Pick an exercise to start tracking</th>
								</tr>
							</thead>
						}
						<tfoot>
							<tr>
								<td colspan="4">
									<button class="btn btn-primary" @onclick="() => addExerciseDialog.Show()">
										<IconAdd /> Add an Exercise
									</button>
								</td>
							</tr>
						</tfoot>
					</table>
				</div>
			</div>
		</div>
		<div class="col m-2">
			<div class="row" style="background-color: darkgrey">
				<div class="col text-danger">
					<h4>
						This workout is not saved! If you leave the page all data will be lost!
					</h4>
				</div>
			</div>
			<div class="row">
				<div class="col">
					<div class="row">
						<div class="col">
							@if (exercises.Count != 0)
							{
								@foreach (var ex in exercises)
								{
									<div class="row" style="background-color: lightgrey">
										<div class="col">
											<div class="row">
												<div class="col">
													<h4>@ex.Name</h4>
												</div>
												<div class="col-auto float-end">
													<button class="btn btn-danger" @onclick="() => RemoveExercise(ex)">
														<IconDelete />
													</button>
												</div>
											</div>
											<div class="row">
												<div class="col">
													<h5 class="text-secondary">Ha van Routine notes, majd alatta ide kell írni</h5>
												</div>
											</div>
											<div class="row">
												<div class="col">
													<textarea class="form-control"
													@bind="ex.Notes"
													rows="1"
													placeholder="Add notes here"
													style="resize:vertical; background-color: lightgrey"
													oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">
													</textarea>
												</div>
											</div>
										</div>
									</div>
									<div class="row" style="background-color: navajowhite">
										<div class="col">
											<ExerciseSets Workout="workout" Exercise="ex" @ref="exerciseBoxRefs[ex.Id]" />
										</div>
									</div>
								}
							}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
}

<AddExerciseDialog AccountDoesId="AccountDoesId" ExerciseList="exercises" @ref="addExerciseDialog" />


@code {
	[Parameter]
	public int AccountDoesId { get; set; } = 0;
	[Parameter]
	public int RoutineId { get; set; } = 0;

	private Account_does_Sport accountDoesSport;
	private Sport sport;
	private Routine routine;

	private Workout workout;
	private List<Exercise> exercises;

	private Timer timer;
	private TimeSpan clock;

	private AddExerciseDialog addExerciseDialog;

	private Dictionary<int, ExerciseSets> exerciseBoxRefs;

	public NewWorkoutPage()
	{
		accountDoesSport = new Account_does_Sport();
		sport = new Sport();
		routine = new Routine();

		workout = new Workout();
		exercises = new List<Exercise>();

		addExerciseDialog = new AddExerciseDialog();

		exerciseBoxRefs = new Dictionary<int, ExerciseSets>();
	}

	protected override void OnInitialized()
	{
		base.OnInitialized();

		timer = new Timer(OnTick, null, 0, 1000);
		clock = TimeSpan.Zero;
	}

	private void OnTick(object? state)
	{
		clock = clock.Add(TimeSpan.FromSeconds(1));
		InvokeAsync(StateHasChanged);
	}

	public override void Dispose()
	{
		timer?.Dispose();
		base.Dispose();
	}

	protected override async Task ValidateParameters()
	{
		if (AccountDoesId == 0 && RoutineId == 0)
			hasInvalidParameter = true;

		if (AccountDoesId != 0 && RoutineId != 0)
			hasInvalidParameter = true;

		if (AccountDoesId != 0)
		{
			accountDoesSport = ValidateAccountDoesSport(AccountDoesId);
			sport = ValidateSport(accountDoesSport.Sport_Id);
		}
		else if (RoutineId != 0)
		{
			routine = await ValidateRoutine(RoutineId);
			accountDoesSport = ValidateAccountDoesSport(routine.Account_does_Sport_Id);
			sport = ValidateSport(accountDoesSport.Sport_Id);
		}

		workout = new Workout { Starttime = DateTime.UtcNow, IsDone = false, IsRoutineExample = false };
		await base.ValidateParameters();
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		await base.OnAfterRenderAsync(firstRender);
		if (firstRender)
		{
			if (!hasInvalidParameter)
				await InvokeAsync(() => _appState.Title = $"New {sport.Name} Workout");
			else
				await InvokeAsync(() => _appState.Title = "Invalid New Workout");

			await InvokeAsync(() => _appState.MainLayout.RerenderLayout());
		}
	}

	private void RemoveExercise(Exercise ex)
	{
		exercises.Remove(ex);
		exerciseBoxRefs.Remove(ex.Id);
	}

	private void MoveExerciseUp(Exercise ex)
	{
		var index = exercises.IndexOf(ex);
		var temp = exercises[index];
		exercises[index] = exercises[index - 1];
		exercises[index - 1] = temp;
	}

	private void MoveExerciseDown(Exercise ex)
	{
		var index = exercises.IndexOf(ex);
		var temp = exercises[index];
		exercises[index] = exercises[index + 1];
		exercises[index + 1] = temp;
	}

	private async Task OnFinishWorkout()
	{
		timer?.Dispose();
		await _appState.ShowLoadingScreenWhileAwaiting(FinishWorkout);
	}

	private async Task<bool> ValidateExercises()
	{
		bool isValid = true;

		foreach (var box in exerciseBoxRefs)
		{ 
			isValid = await box.Value.ValidateSets();
			if (!isValid)
				break;
		}	

		return isValid;
	}

	private async Task FinishWorkout()
	{
		bool isValid = await ValidateExercises();
		if (!isValid)
		{
			
		}
		else
		{
			workout.IsDone = true;
		}
	}
}